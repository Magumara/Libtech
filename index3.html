<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LIBTECH — Répertoire</title>
  <meta name="description" content="LIBTECH | Répertoire de technologies accessibles" />
  <link rel="icon" href="data:," />

  <style>
    /* ===============================
       VARIABLES & MISE EN PAGE GLOBALES
       =============================== */
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #667085;
      --accent: #2563eb;
      --border: #e3e6ef;
      --shadow: 0 16px 48px rgba(15, 23, 42, .08);
      --maxw: 1100px;
      --header: 64px;
      --sidebar: 300px;
      --safe: env(safe-area-inset-bottom, 0px);
      --radius: 14px;
      --radius-lg: 18px;
      --tap: 44px;
      --space: 16px;
      --fs: clamp(14px, 1.6vw, 16px);
      --fs-sm: clamp(12px, 1.2vw, 14px);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--ink);
      background: var(--bg);
      font: var(--fs)/1.55 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial
    }

    a {
      color: inherit;
      text-decoration: none
    }

    img {
      max-width: 100%;
      display: block
    }

    input,
    select,
    button {
      font: inherit
    }

    /* ===============================
       BOUTONS & CHAMPS
       =============================== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: var(--tap);
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #f4f7fb;
      color: var(--ink);
      cursor: pointer
    }

    .btn:hover {
      border-color: #cdd4e2
    }

    /* ===============================
       EN-TÊTE FIXE (VISIBLE PARTOUT)
       =============================== */
    header {
      position: sticky;
      top: 0;
      height: var(--header);
      display: flex;
      align-items: center;
      background: color-mix(in oklab, var(--panel) 92%, transparent);
      backdrop-filter: saturate(140%) blur(6px);
      border-bottom: 1px solid var(--border);
      z-index: 50
    }

    .wrap {
      max-width: var(--maxw);
      margin: 0 auto;
      width: 100%;
      padding: 0 var(--space);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 800
    }

    .brand img {
      height: 26px;
      width: auto
    }

    /* ===============================
       NAVIGATION PRINCIPALE (ONGLETS)
       =============================== */
    nav.topnav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .navlink {
      padding: 10px 12px;
      border-radius: 12px;
      min-height: var(--tap);
      display: inline-flex;
      align-items: center
    }

    .navlink[aria-current="page"] {
      background: #eaf1ff;
      color: #2563eb
    }

    .spacer {
      flex: 1
    }

    /* ===============================
       OUTILS D’EN-TÊTE (RECHERCHE, LANGUE, POLICE)
       =============================== */
    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .select,
    .toolbar input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      min-height: var(--tap);
      color: var(--ink)
    }

    /* ===============================
       PIED DE PAGE
       =============================== */
    footer {
      margin-top: 40px;
      color: #f9fafb;
    }

    /* Outer container: three blocks (left / center / right) */
    .footer-wrap {
      max-width: var(--maxw);
      margin: 0 auto;
      width: 100%;
      display: grid;
      grid-template-columns: 0.8fr 1.6fr 0.9fr;
      min-height: 200px;
      border-radius: 18px 18px 0 0;
      overflow: hidden;
      box-shadow: 0 16px 48px rgba(15, 23, 42, 0.18);
    }

    /* Shared padding for all footer blocks */
    .footer-left,
    .footer-center,
    .footer-right {
      padding: 24px var(--space);
    }

    /* Background colors for each block */
    /* For now center and right share the same color */
    .footer-left {
      background: #279e9c;
    }

    .footer-center {
      background: #0f6fabe2;
    }

    .footer-right {
      background: #0f6fabe2;
    }

    /* Stack blocks on small screens */
    @media (max-width: 900px) {
      .footer-wrap {
        grid-template-columns: 1fr;
      }
    }

    /* Titles in footer */
    .footer-title {
      font-weight: 700;
      margin: 0 0 8px;
      font-size: 15px;
    }

    /* Regular footer text */
    .footer-text {
      font-size: var(--fs-sm);
      line-height: 1.5;
      margin: 0;
    }

    /* Container for lists of links */
    .footer-links {
      margin-top: 10px;
    }

    /* Individual footer links */
    .footer-links a {
      display: block;
      font-size: var(--fs-sm);
      text-decoration: underline;
      margin-bottom: 4px;
      color: #f9fafb;
    }

    /* Small meta text */
    .footer-meta {
      margin-top: 10px;
      font-size: var(--fs-sm);
      opacity: 0.9;
    }

    /* Social icons row */
    .footer-social {
      display: flex;
      gap: 16px;
      margin-top: 18px;
    }

    /* SVG icons */
    .footer-icon svg {
      width: 26px;
      height: 26px;
      color: #ffffff;
      transition: opacity 0.2s ease;
    }

    .footer-icon:hover svg {
      opacity: 0.7;
    }

    /* Back to top link */
    .footer-top-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: var(--fs-sm);
      text-decoration: underline;
      margin-top: 12px;
      color: #f9fafb;
    }



    /* ===============================
       CONTENEURS DE PAGES
       =============================== */
    main {
      min-height: 60vh
    }

    .page {
      max-width: var(--maxw);
      margin: 18px auto;
      padding: 0 var(--space)
    }

    /* ===============================
       RÉPERTOIRE : BARRE HAUTE & DISPOSITION
       =============================== */
    .repo-topbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap
    }

    .pill {
      font-size: 12px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      min-height: 28px;
      display: inline-flex;
      align-items: center
    }

    .repo-layout {
      display: grid;
      grid-template-columns: var(--sidebar) 1fr;
      gap: 16px
    }

    @media (max-width:960px) {
      .repo-layout {
        grid-template-columns: 1fr
      }
    }

    .sidebar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, .05)
    }

    .facet {
      border-top: 1px dashed var(--border);
      padding: 10px 0
    }

    .facet:first-child {
      border-top: none
    }

    .facet h4 {
      margin: 0 0 8px;
      font-size: var(--fs-sm);
      color: #475569
    }

    .facet .opt {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      min-height: 36px;
      line-height: 1.3;
      word-break: break-word
    }

    /* ===============================
       GRILLE DE CARTES (LISTE DES ÉLÉMENTS)
       =============================== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, .05);
      cursor: pointer;
      min-height: 120px
    }

    .card:hover {
      box-shadow: 0 14px 36px rgba(37, 99, 235, .12);
      border-color: #c7d2fe
    }

    .card .title {
      font-style: italic;
      font-weight: 800
    }

    .card .desc {
      color: var(--muted);
      font-size: var(--fs-sm);
      margin-top: 6px
    }

    /* ===============================
       FICHE DÉTAILLÉE (MISE EN PAGE)
       =============================== */
    .article {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow)
    }

    .hero {
      padding: 22px 22px 10px;
      border-bottom: 1px solid var(--border)
    }

    .hero h2 {
      margin: 0;
      font-size: clamp(22px, 3.2vw, 28px);
      line-height: 1.15;
      font-weight: 800
    }

    .meta {
      color: var(--muted)
    }

    .section {
      padding: 16px 22px
    }

    .sheet {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      padding: 16px
    }

    @media (max-width:900px) {
      .sheet {
        grid-template-columns: 1fr
      }
    }

    .sheet .title {
      text-align: center;
      font-style: italic;
      font-weight: 800;
      font-size: clamp(22px, 3vw, 28px);
      margin: 6px 0 2px
    }

    .sheet .keywords {
      text-align: center;
      color: #9aa3b2;
      font-size: var(--fs-sm);
      margin-bottom: 10px
    }

    .sheet .line {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      color: #475569;
      margin: 12px 0 10px
    }

    .sheet .label {
      color: #334155
    }

    .sheet .desc h4 {
      margin: 0 0 8px;
      font-size: 18px
    }

    .sheet .descbox {
      min-height: 200px;
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--ink);
      border: 1px solid var(--border);
      background: var(--panel);
      line-height: 1.5
    }

    .sheet .imagebox {
      border: 1px solid var(--border);
      border-radius: 16px;
      min-height: 200px;
      background: #eef1f6;
      display: grid;
      place-items: center;
      overflow: hidden
    }

    .sheet .imagebox img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover
    }

    .sheet .imgcap {
      color: #a0a7b2;
      font-size: 12px;
      text-align: right;
      margin-top: 6px
    }

    .sheet dl {
      margin: 0
    }

    .sheet dt {
      float: left;
      clear: left;
      width: 120px;
      color: #5b6676
    }

    .sheet dd {
      margin-left: 130px
    }

    .sheet dd a {
      color: #2563eb;
      text-decoration: underline
    }

    /* ===============================
       COMPORTEMENT SPÉCIFIQUE À L’ACCUEIL
       - Masquer la recherche du header uniquement sur l’accueil
       - Grande barre de recherche centrée
       =============================== */
    body.home #q {
      display: none !important
    }

    .home-hero {
      display: grid;
      place-items: center;
      min-height: 58vh;
      padding: 24px
    }

    .home-search {
      max-width: 720px;
      width: 100%;
      text-align: center
    }

    .home-search h2 {
      font-size: clamp(24px, 3.5vw, 36px);
      margin: 0 0 12px;
      font-weight: 800
    }

    .home-search p {
      color: #667085;
      margin: 0 0 18px
    }

    .home-search .search-wrap {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .home-search input[type="search"] {
      flex: 1;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      font-size: 16px
    }

    .home-search button {
      padding: 14px 16px;
      border-radius: 14px
    }

    /* ===============================
       RÉPERTOIRE : FILTRES REPLIABLES
       =============================== */
    .filters-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #eef2f7;
      cursor: pointer;
      margin-bottom: 12px;
      transition: background .2s ease
    }

    .filters-toggle:hover {
      background: #e2e8f0
    }

    .repo-layout.with-filters {
      grid-template-columns: var(--sidebar) 1fr
    }

    .repo-layout.no-filters {
      grid-template-columns: 1fr
    }

    .sidebar.hidden {
      display: none
    }
  </style>

  <!-- Dépendance : PapaParse pour lire le CSV public -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body id="top">
  <!-- ==========================
       EN-TÊTE (logo, onglets, outils)
       ========================== -->
  <header>
    <div class="wrap">
      <a class="brand" href="#/">
        <img alt="LIBTECH" src="https://dummyimage.com/120x40/2563eb/ffffff&text=LIBTECH" />
      </a>
      <nav class="topnav">
        <a class="navlink" href="#/" data-nav>Accueil</a>
        <a class="navlink" href="#/repertoire" data-nav>Répertoire</a>
        <a class="navlink" href="#/contact" data-nav>Nous contacter</a>
        <a class="navlink" href="#/a-propos" data-nav>À propos</a>
      </nav>
      <div class="spacer"></div>
      <div class="toolbar">
        <!-- Recherche globale (utilisée dans le répertoire ; masquée sur l’accueil) -->
        <input id="q" class="select" placeholder="Rechercher…" aria-label="Recherche globale" />
        <!-- Sélecteur de langue (actuellement inactif par choix) -->
        <select id="lang" class="select" title="Langue" aria-label="Langue">
          <option value="fr" selected>Français</option>
          <option value="en">English</option>
        </select>
        <!-- Démonstration : changement de police -->
        <select id="font" class="select" title="Police" aria-label="Police">
          <option value="system" selected>Système</option>
          <option value="serif">Serif</option>
          <option value="mono">Mono</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Zone d’affichage des vues -->
  <main>
    <div id="page" class="page"></div>
  </main>

  <!-- ==========================
       PIED DE PAGE (liens utiles)
       ========================== -->
  <footer>
    <div class="footer-wrap">

      <!-- LEFT BLOCK: logo + short description + social icons -->
      <section class="footer-left" aria-label="About LibTech">
        <h2 class="footer-title">LibTech</h2>
        <p class="footer-text">
          Plateforme collaborative dédiée aux technologies d’assistance,
          améliorée chaque année par une nouvelle promotion d’étudiants.
        </p>

        <div class="footer-social" aria-label="Social links">
          <!-- GitHub -->
          <a href="#" class="footer-icon" title="GitHub" aria-label="GitHub">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path
                d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77 5.44 5.44 0 0 0 3.5 9.5c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 19v3" />
            </svg>
          </a>

          <!-- LinkedIn -->
          <a href="#" class="footer-icon" title="LinkedIn" aria-label="LinkedIn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" />
              <rect x="2" y="9" width="4" height="12" />
              <circle cx="4" cy="4" r="2" />
            </svg>
          </a>

          <!-- Instagram -->
          <a href="#" class="footer-icon" title="Instagram" aria-label="Instagram">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5" />
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" />
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5" />
            </svg>
          </a>

          <!-- Twitter / X -->
          <a href="#" class="footer-icon" title="Twitter" aria-label="Twitter">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M18 2H6a4 4 0 0 0-4 4v12a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4V6a4 4 0 0 0-4-4ZM8 8l8 8m0-8-8 8" />
            </svg>
          </a>
        </div>
      </section>

      <!-- CENTER BLOCK: legal links + meta -->
      <section class="footer-center" aria-label="Legal and resources">
        <h2 class="footer-title">Resources</h2>

        <div class="footer-links">
          <a href="#/mentions-legales">Mentions légales</a>
          <a href="#/confidentialite">Politique d’accessibilité (WCAG)</a>
          <a href="#/plan-du-site">Plan du site</a>
        </div>

        <p class="footer-meta">
          Projet étudiant dédié à l’innovation et à l’accessibilité numérique.<br>
          © 2025 LibTech — Master TECH, Université de Bordeaux.<br>
          Projet en amélioration continue (promotions 2024–2026).
        </p>
      </section>

      <!-- RIGHT BLOCK: navigation + back to top -->
      <section class="footer-right" aria-label="Navigation and options">
        <h2 class="footer-title">Navigation</h2>

        <div class="footer-links">
          <a href="#/">Accueil</a>
          <a href="#/a-propos">À propos</a>
          <a href="#/repertoire">Répertoire</a>
          <a href="#/contact">Nous contacter</a>
        </div>

        <p class="footer-text" style="margin-top: 14px;">
          EN / FR<br>
          Mode sombre / clair
        </p>

        <a class="footer-top-link" href="#top">
          <span>↑</span> Retour en haut
        </a>
      </section>

    </div>
  </footer>


  <script>
    (() => {
      /* ============================================================
         SOURCE DES DONNÉES (CSV PUBLIC GOOGLE SHEETS)
         - Si vous changez de feuille : garder les intitulés ou ajuster le mapping COL
         ============================================================ */
      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTrbhCHyINYJMEBbnl_SGBujZOOUB0rw4WnXWirV9dUF_PaktI2oVM0ubMRK6B_Xw/pub?output=csv';

      /* ============================================================
         FONCTIONS UTILITAIRES (sélecteurs, échappement, formats)
         ============================================================ */
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const esc = (s) => String(s == null ? '' : s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#39;");
      const slug = (s) => String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      const isUrl = (v) => /^(https?:)?\/\//i.test(String(v));
      const isImg = (v) => /\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(String(v));

      /* ============================================================
         ÉTAT GLOBAL DE L’APPLICATION
         - Données en mémoire, index, filtres actifs
         ============================================================ */
      let rows = [], headers = [], bySlug = new Map();
      let expandedFacets = new Set();

      // Éléments actifs par catégorie de filtre (libellés en français)
      let activeTokens = new Map([
        ['Besoin', new Set()],
        ['Technologie', new Set()],
        ["Tranche d'âge", new Set()],
        ['Handicap', new Set()],
        ['Langue', new Set()],
        ['Prix', new Set()],
        ['Localisation', new Set()],
      ]);

      // Correspondance des colonnes (jeu de données en français)
      const COL = {
        name: { base: ['Nom'], suffix: true },
        description: { base: ['Description'], suffix: true },
        needs: { base: ['Besoin', 'Besoins'], suffix: true },
        technology: { base: ['Technologie', 'Type de technologie', 'Type_technologie'], suffix: true },
        age: { base: ["Tranche d'âge", "Tranche d'age", "Tranche_age", "Age"], suffix: true },
        disability: { base: ['Handicap'], suffix: true },
        langs: { base: ['Langue', 'Langues'], suffix: true },
        price: { base: ['Prix', 'Tarif', 'Coût', 'Cout'], suffix: true },
        location: { base: ['Localisation', 'Pays', 'Pays fournisseurs'], suffix: true },
      };

      const headersIndex = () => { const m = new Map(); headers.forEach(h => m.set(String(h || '').trim().toLowerCase(), h)); return m; };
      const findHeader = (cand) => headers.find(h => new RegExp(`^${cand}$`, 'i').test(h)) || null;

      // Sélection d’un en-tête correspondant à une clé logique
      // Stratégie : Base_fr puis Base ; enfin, correspondance souple si besoin
      function pickHeader(key) {
        const info = COL[key]; if (!info) return null;
        const H = headersIndex(); const list = [];
        for (const b of info.base) { if (info.suffix) { list.push(b + '_fr'); } list.push(b); }
        for (const c of list) { const hit = findHeader(c) || H.get(c.toLowerCase()); if (hit) return hit; }
        for (const b of info.base) { for (const h of headers) { if (new RegExp(b, 'i').test(h)) return h; } }
        return null;
      }
      const pickValue = (row, key) => { const h = pickHeader(key); return (h && row[h] != null && String(row[h]).trim() !== '') ? row[h] : ''; };
      const nameKey = () => pickHeader('name') || headers[0] || 'Nom';

      /* ============================================================
         CHARGEMENT DU CSV (PapaParse)
         - Télécharge le CSV public et prépare les lignes/colonnes
         ============================================================ */
      async function loadCSV(url) {
        return new Promise((resolve, reject) => {
          Papa.parse(url, {
            header: true, download: true, skipEmptyLines: true,
            complete: res => {
              // Nettoyage des lignes vides
              const data = (res.data || []).filter(o => Object.values(o).some(v => String(v || '').trim() !== ''));
              headers = (res.meta?.fields || Object.keys(data[0] || {})).map(h => String(h || '').trim());
              const nkey = nameKey();
              rows = data.map((r, i) => ({ ...r, __slug: slug(r[nkey] || `item-${i}`) }));
              bySlug = new Map(rows.map(r => [r.__slug, r]));
              // Tri alphabétique par nom (insensible à la casse/accents)
              rows.sort((a, b) => String(a[nkey] || '').localeCompare(String(b[nkey] || ''), 'fr', { sensitivity: 'base' }));
              route(); resolve();
            },
            error: err => { console.error(err); alert('Erreur CSV'); reject(err); }
          });
        });
      }

      /* ============================================================
         GESTION DES FILTRES (construction, valeurs, correspondances)
         ============================================================ */
      const facetDefs = () => [
        { key: 'needs', label: 'Besoin' },
        { key: 'technology', label: 'Technologie' },
        { key: 'age', label: "Tranche d'âge" },
        { key: 'disability', label: 'Handicap' },
        { key: 'langs', label: 'Langue' },
        { key: 'price', label: 'Prix' },
        { key: 'location', label: 'Localisation' },
      ];

      // Calcule les valeurs possibles par catégorie (dédoublonnées + triées)
      function facetValues() {
        const out = new Map(); for (const f of facetDefs()) out.set(f.label, new Set());
        for (const r of rows) {
          for (const f of facetDefs()) {
            String(pickValue(r, f.key) || '')
              .split(',').map(s => s.trim()).filter(Boolean)
              .forEach(t => out.get(f.label).add(t));
          }
        }
        const obj = {};
        for (const f of facetDefs()) {
          obj[f.label] = [...out.get(f.label)].sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));
        }
        return obj;
      }

      // Logique de filtrage : correspond si AU MOINS une valeur cochée apparaît dans la ligne
      function matchRow(r) {
        const any = [...activeTokens.values()].some(s => s.size > 0); if (!any) return true;
        for (const f of facetDefs()) {
          const selected = activeTokens.get(f.label); if (!selected?.size) continue;
          const tokens = String(pickValue(r, f.key) || '').split(',').map(s => s.trim());
          if (tokens.some(v => selected.has(v))) return true;
        }
        return false;
      }

      // Rend les blocs de filtres avec bouton « Voir plus / Voir moins »
      function renderFacets(intoEl) {
        const facets = facetValues();
        const html = Object.entries(facets).map(([label, vals]) => {
          const all = vals;
          const isExpanded = expandedFacets.has(label);
          const visible = isExpanded ? all : all.slice(0, 5);

          const opts = visible.map(v => {
            const checked = activeTokens.get(label)?.has(v) ? 'checked' : '';
            return `<label class="opt"><input type="checkbox" data-facet="${esc(label)}" value="${esc(v)}" ${checked}> ${esc(v)}</label>`;
          }).join('') || '<div class="opt">(aucun)</div>';

          const moreBtn = all.length > 5
            ? `<button class="see-more" data-facet-toggle="${esc(label)}">${isExpanded ? 'Voir moins' : 'Voir plus'}</button>`
            : '';

          return `<div class="facet"><h4>${esc(label)}</h4>${opts}${moreBtn}</div>`;
        }).join('');

        intoEl.innerHTML = html;

        // Gestion des cases à cocher → mise à jour du filtre + rechargement des cartes
        intoEl.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            const label = cb.getAttribute('data-facet');
            const set = activeTokens.get(label);
            if (cb.checked) set.add(cb.value); else set.delete(cb.value);
            applyFiltersAndRenderCards();
          });
        });

        // Boutons « Voir plus / Voir moins »
        intoEl.querySelectorAll('.see-more').forEach(btn => {
          btn.addEventListener('click', () => {
            const label = btn.getAttribute('data-facet-toggle');
            if (expandedFacets.has(label)) expandedFacets.delete(label);
            else expandedFacets.add(label);
            renderFacets(intoEl);
          });
        });
      }
      const renderAllFacetBlocks = () => { const s = $('#facetRoot'); if (s) renderFacets(s); };

      /* ============================================================
         AFFICHAGE DES CARTES (liste) + RECHERCHE GLOBALE
         ============================================================ */
      function card(r) {
        const nkey = nameKey();
        const name = r[nkey] || '(sans nom)';
        const desc = pickValue(r, 'description');
        const short = String(desc || '').length > 140 ? String(desc).slice(0, 140).trim() + '…' : (desc || '');
        return `
        <article class="card" tabindex="0" role="button" aria-label="${esc(name)}" data-slug="${esc(r.__slug)}">
          <div class="title"><em><strong>${esc(name)}</strong></em></div>
          <div class="desc">${short ? esc(short) : '<span class="meta">Pas de description</span>'} <a href="#/repertoire/${esc(r.__slug)}">Voir plus…</a></div>
        </article>`;
      }

      function applyFiltersAndRenderCards() {
        const nkey = nameKey();
        const grid = $('#gridRoot');
        const count = $('#count');

        // La recherche globale utilise le champ du header (#q) uniquement sur le répertoire
        let q = '';
        if (location.hash.startsWith('#/repertoire')) q = ($('#q')?.value || '').trim().toLowerCase();

        let list = rows.filter(matchRow);
        if (q.length >= 2) list = list.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));

        list.sort((a, b) => String(a[nkey] || '').localeCompare(String(b[nkey] || ''), 'fr', { sensitivity: 'base' }));
        grid.innerHTML = list.map(card).join('') || `<div class="meta">Aucun résultat.</div>`;
        count.textContent = list.length === 1 ? '1 élément' : `${list.length} éléments`;

        // Navigation par carte (clic ou clavier)
        grid.querySelectorAll('.card').forEach(el => {
          el.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); location.hash = `#/repertoire/${el.dataset.slug}`; } });
          el.addEventListener('click', () => location.hash = `#/repertoire/${el.dataset.slug}`);
        });
      }

      /* ============================================================
         VUES (ACCUEIL, CONTACT, À PROPOS, RÉPERTOIRE, DÉTAIL)
         ============================================================ */
      function viewHome() {
        $('#page').innerHTML = `
        <section class="page">
          <div class="home-hero">
            <div class="home-search">
              <h2>LIBTECH — Répertoire des technologies accessibles</h2>
              <p>Recherchez une techno, un besoin, une langue…</p>
              <form id="homeSearchForm" class="search-wrap" role="search">
                <input id="homeSearchInput" type="search" placeholder="Rechercher… (min 2 caractères)" autocomplete="off">
                <button class="btn" type="submit">Rechercher</button>
              </form>
            </div>
          </div>
        </section>`;

        // Mise au focus du champ de recherche dès l’arrivée
        setTimeout(() => $('#homeSearchInput')?.focus(), 100);

        // À la soumission : copie la recherche dans la barre du header et ouvre le répertoire
        $('#homeSearchForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const q = $('#homeSearchInput').value || '';
          if ($('#q')) $('#q').value = q;
          location.hash = '#/repertoire';
          setTimeout(() => applyFiltersAndRenderCards(), 0);
        });
      }

      function viewContact() {
        $('#page').innerHTML = `
    <section class="page article">

      <!-- Titre -->
      <div class="hero">
        <h2>Contact</h2>
      </div>

      <!-- Texte principal (Figma) -->
      <div class="section">
        <p>
          Où que vous soyez, si vous avez une question sur LibTech, une suggestion
          de technologie d’assistance ou une correction à proposer, n’hésitez pas à nous écrire.
          <br>
          Nous serons ravis d’échanger avec vous.
        </p>
      </div>

      <!-- Bloc bleu -->
      <div style="
        background:#315A77;
        padding:40px 24px;
        border-radius:12px;
        margin:20px 22px 40px 22px;
        color:white;
      ">
        <h3 style="margin-top:0;">Contact</h3>
        <p style="max-width:420px; line-height:1.6;">
          Nous vous invitons à nous contacter par e-mail en utilisant le bouton ci-dessous.
          L’équipe LibTech vous répondra dans les meilleurs délais.
        </p>

        <a href="mailto:promom2sc@gmail.com"
           style="
             display:inline-block;
             margin-top:20px;
             padding:12px 24px;
             background:white;
             color:#0f172a;
             border-radius:8px;
             font-weight:600;
             text-decoration:none;
           ">
          Nous écrire
        </a>
      </div>

    </section>`;
      }

      function viewAbout() {
        $('#page').innerHTML = `
    <section class="page article">

      <!-- Titre principal -->
      <div class="hero">
        <h2>À propos</h2>
      </div>

      <!-- Texte d’intro (paragraphe du haut) -->
      <div class="section">
        <p>
          LibTech est une plateforme collaborative dédiée aux technologies d’assistance,
          développée dans le cadre du Master TECH de l’Université de Bordeaux.
          Elle vise à rendre plus accessibles les solutions d’assistance existantes en
          proposant un répertoire clair, actualisé et pensé pour tous.
        </p>
      </div>

      <!-- Bloc Mission / Vision -->
      <div style="
        background:#175b67;
        padding:24px 22px 32px;
        border-radius:16px;
        margin:0 22px 32px;
        color:#ffffff;
      ">
        <div style="
          display:grid;
          grid-template-columns:1fr 1fr;
          gap:24px;
          align-items:flex-start;
        ">
          <!-- Mission -->
          <div>
            <h3 style="margin-top:0;">Mission</h3>
            <p style="white-space:pre-line; line-height:1.6;">
Notre mission est de faciliter l’accès
à l’information sur les technologies
d’assistance
en proposant un répertoire structuré,
fiable et simple à explorer.
Nous souhaitons soutenir les
étudiants, professionnels, aidants
et toute personne concernée par le
handicap dans la découverte d’outils
adaptés.</p>
          </div>

          <!-- Vision -->
          <div>
            <h3 style="margin-top:0;">Vision</h3>
            <p style="white-space:pre-line; line-height:1.6;">
Notre vision est de construire une
ressource vivante et évolutive,
améliorée chaque année par les
nouvelles promotions du Master TECH.
Nous imaginons une plateforme
ouverte, durable et inclusive,
qui accompagne l’innovation
numérique et la conception accessible.</p>
          </div>
        </div>
      </div>

      <!-- Équipe et collaboration -->
      <div class="section">
        <h3>Équipe et collaboration</h3>
        <p>
          Le projet LibTech est porté par les étudiants du parcours Technologies, Ergonomie,
          Cognition, Handicap (TECH).
          Chaque promotion contribue à la mise à jour du répertoire, au design du site et à
          l’accessibilité des contenus.
          Merci aux enseignants et aux partenaires pour leur accompagnement.
        </p>
      </div>

      <!-- Blocs Équipe actuelle / précédente / Encadrement -->
      <div style="
        background:#165c6f;
        padding:40px 22px 48px;
        color:#ffffff;
      ">
        <section style="max-width:720px; margin:0 auto 32px;">
          <h3>Équipe actuelle (Promotion 2024–2026)</h3>
          <p>
            Le développement de LibTech est assuré par la Promotion 2024–2026 du Master TECH – Université de Bordeaux.
            Cette promotion contribue à la mise à jour du répertoire, à l’évolution du design du site et à l’amélioration
            continue de son accessibilité.
          </p>
        </section>

        <section style="max-width:720px; margin:0 auto 32px;">
          <h3>Équipe précédente (Promotion 2023–2025)</h3>
          <p>
            La Promotion 2023–2025 a posé les bases du projet LibTech, en définissant la structure initiale du répertoire
            ainsi que les orientations générales du design et de l’accessibilité.
            Nous les remercions chaleureusement pour leur contribution essentielle.
          </p>
        </section>

        <section style="max-width:720px; margin:0 auto;">
          <h3>Encadrement</h3>
          <p>
            Le projet est encadré par l’équipe pédagogique du Master TECH, avec le soutien des enseignant·e·s
            et partenaires professionnels.
          </p>
        </section>
      </div>

    </section>`;
      }

      // Page Répertoire : filtres masqués par défaut, bouton pour les afficher
      function viewRepertoire() {
        $('#page').innerHTML = `
        <section class="page">
          <div class="repo-topbar">
            <button id="toggleFilters" class="filters-toggle">☰ Afficher les filtres</button>
            <span class="pill" id="count" aria-live="polite">0</span>
          </div>
          <div class="repo-layout no-filters" id="repoLayout">
            <aside class="sidebar hidden" id="facetRoot" aria-label="Filtres"></aside>
            <div><div class="grid" id="gridRoot"></div></div>
          </div>
        </section>`;

        // Premier rendu (filtres cachés)
        renderAllFacetBlocks();
        applyFiltersAndRenderCards();

        // Bouton d’affichage/masquage des filtres latéraux
        const btn = $('#toggleFilters');
        const layout = $('#repoLayout');
        const sidebar = $('#facetRoot');
        btn.addEventListener('click', () => {
          const isHidden = sidebar.classList.contains('hidden');
          if (isHidden) {
            sidebar.classList.remove('hidden');
            layout.classList.replace('no-filters', 'with-filters');
            btn.textContent = '✖ Masquer les filtres';
          } else {
            sidebar.classList.add('hidden');
            layout.classList.replace('with-filters', 'no-filters');
            btn.textContent = '☰ Afficher les filtres';
          }
        });
      }

      // Page Détail : une seule sous-page dynamique basée sur la ligne sélectionnée
      function viewDetail(slugId) {
        const r = bySlug.get(slugId);
        if (!r) {
          $('#page').innerHTML = `<section class="page"><p>Élément introuvable.</p><p><a class="btn" href="#/repertoire">← Retour au répertoire</a></p></section>`;
          return;
        }
        const nkey = nameKey();
        const name = r[nkey] || '(sans nom)';

        // Champs usuels récupérés sur la ligne
        const handicap = pickValue(r, 'disability');
        const besoinHeader = headers.find(h => /^(besoin|besoins)$/i.test(h) || /^besoin_?fr$/i.test(h));
        const besoin = besoinHeader ? (r[besoinHeader] || '') : '';
        const description = pickValue(r, 'description');

        // Image (priorité aux colonnes "Image*" ; sinon première URL d’image trouvée)
        const imageHeader = headers.find(h => /^(image|illustration|photo|visuel)(_fr)?$/i.test(h)) || headers.find(h => isUrl(r[h]) && isImg(r[h]));
        const imageUrl = imageHeader ? String(r[imageHeader]) : '';
        const imgCapHeader = headers.find(h => /^(description[_ ]?image|legende[_ ]?image)$/i.test(h));
        const imageCaption = imgCapHeader ? String(r[imgCapHeader]) : '';

        // Liens et métadonnées
        const siteHeader = headers.find(h => /^(site|url|lien|site web)$/i.test(h));
        const site = siteHeader ? String(r[siteHeader]) : '';
        const localisation = pickValue(r, 'location'); // Utilise la colonne Localisation
        const langues = pickValue(r, 'langs');
        const dateHeader = headers.find(h => /^(date|année)$/i.test(h));
        const dateVal = dateHeader ? String(r[dateHeader]) : '';
        const structHeader = headers.find(h => /^(structure|organisme|organisation)$/i.test(h));
        const structure = structHeader ? String(r[structHeader]) : '';

        $('#page').innerHTML = `
        <section class="page article">
          <div class="sheet">
            <div class="left">
              <div class="title">${esc(name)}</div>
              <div class="line">
                <div><span class="label">Handicap :</span> ${handicap ? esc(handicap) : ''}</div>
                <div><span class="label">Besoin :</span> ${besoin ? esc(besoin) : ''}</div>
              </div>
              <div class="desc">
                <h4>Description</h4>
                <div class="descbox">${description ? esc(description) : 'Pas de description'}</div>
              </div>
            </div>
            <div class="right">
              <div class="imagebox">
                ${imageUrl && isUrl(imageUrl) && isImg(imageUrl) ? `<img src="${esc(imageUrl)}" alt="image">` : `<span>Image</span>`}
              </div>
              <div class="imgcap">${imageCaption ? esc(imageCaption) : ''}</div>
              <dl>
                ${site ? `<dt>Site</dt><dd><a href="${esc(site)}" target="_blank" rel="noopener noreferrer">${esc(site)}</a></dd>` : ''}
                ${localisation ? `<dt>Localisation</dt><dd>${esc(localisation)}</dd>` : ''}
                ${langues ? `<dt>Langue</dt><dd>${esc(langues)}</dd>` : ''}
                ${dateVal ? `<dt>Date</dt><dd>${esc(dateVal)}</dd>` : ''}
                ${structure ? `<dt>Structure</dt><dd>${esc(structure)}</dd>` : ''}
              </dl>
              <p style="margin-top:12px"><a class="btn" href="#/repertoire">← Retour au répertoire</a></p>
            </div>
          </div>
        </section>`;
      }

      /* ============================================================
         ROUTEUR (mise à jour de la vue en fonction du hash)
         ============================================================ */
      function setActiveNav() {
        const h = location.hash || '#/';
        // Détermine l’onglet actif (le répertoire gère aussi les sous-routes)
        $$('a[data-nav]').forEach(a => {
          const href = a.getAttribute('href');
          const isRepo = href === '#/repertoire' && h.startsWith('#/repertoire');
          const isExact = href === h || (href === '#/' && (h === '#' || h === '#/'));
          a.setAttribute('aria-current', (isRepo || isExact) ? 'page' : 'false');
        });

        // Sur l’accueil, masquer la recherche du header via la classe body.home
        if (h === '#/' || h === '#') {
          document.body.classList.add('home');
        } else {
          document.body.classList.remove('home');
        }
      }

      function route() {
        const h = location.hash || '#/';
        setActiveNav();
        const mDetail = h.match(/^#\/repertoire\/([a-z0-9_.-]+)/i);
        if (mDetail) { viewDetail(mDetail[1]); return; }
        if (h.startsWith('#/repertoire')) { viewRepertoire(); return; }
        if (h === '#/' || h === '#') { viewHome(); return; }
        if (h === "#/contact") { viewContact(); return; }
        if (h === "#/a-propos") { viewAbout(); return; }
        if (h === "#/plan-du-site") { $('#page').innerHTML = `<section class="page article"><div class="hero"><h2>Plan du site</h2></div><div class="section"><p>(Contenu à compléter.)</p></div></section>`; return; }
        if (h === "#/mentions-legales") { $('#page').innerHTML = `<section class="page article"><div class="hero"><h2>Mentions légales</h2></div><div class="section"><p>(Contenu à compléter.)</p></div></section>`; return; }
        if (h === "#/confidentialite") { $('#page').innerHTML = `<section class="page article"><div class="hero"><h2>Politique de confidentialité</h2></div><div class="section"><p>(Contenu à compléter.)</p></div></section>`; return; }
        viewHome();
      }
      window.addEventListener('hashchange', route);

      /* ============================================================
         COMPORTEMENTS GLOBAUX (recherche, langue, police)
         ============================================================ */
      // Recherche dans le header : filtrage en direct sur la page Répertoire
      $('#q').addEventListener('input', () => {
        if (location.hash.startsWith('#/repertoire')) applyFiltersAndRenderCards();
      });

      // Sélecteur de langue : inactif pour l’instant (prévu pour i18n futur)
      $('#lang').addEventListener('change', () => { /* inactif volontairement */ });

      // Changement de police en direct
      $('#font').addEventListener('change', () => {
        const v = $('#font').value;
        document.body.style.fontFamily = v === 'system' ? '' : (v === 'serif' ? 'Georgia,serif' : 'ui-monospace, Menlo, Consolas, "Courier New", monospace');
      });

      /* ============================================================
         DÉMARRAGE DE L’APPLICATION
         ============================================================ */
      (async function init() { await loadCSV(CSV_URL); })();
    })();
  </script>
</body>

</html>